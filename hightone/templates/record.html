{% extends "base.html" %}

{% block content %}
<h1 style="margin-top: 100px; text-align: center; font-family: 'Arial', sans-serif; color: #4CAF50;">녹음 페이지</h1>

<!-- 버튼과 메시지 컨테이너 -->
<div style="display: flex; justify-content: center; align-items: center; margin-top: 50px; gap: 20px;">
    <!-- 최저음 녹음 버튼 -->
    <div style="text-align: center;">
        <button id="startLowRecording" style="padding: 15px 30px; background-color: #4CAF50; color: white; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;">
            최저음 녹음 시작
        </button>
    </div>

    <!-- 최고음 녹음 버튼 -->
    <div style="text-align: center;">
        <button id="startHighRecording" style="padding: 15px 30px; background-color: #4CAF50; color: white; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;" disabled>
            최고음 녹음 시작
        </button>
    </div>
</div>

<!-- 메세지 컨테이너 1: 좌우로 배치되는 컨테이너 -->
<div id="messageContainer1" style="display: flex; justify-content: center; margin-top: 20px;">
    <div id="lowMessageContainer" style="text-align: center; margin-right: 15px; padding: 10px 30px; border-radius: 8px; color: #ff9f22 ; min-width: 200px;">
        <!-- 최저음 녹음 완료 메시지가 여기에 표시됩니다 -->
    </div>
    <div id="highMessageContainer" style="text-align: center; margin-left: 15x; padding: 10px 30px; border-radius: 8px; color: #5058f5; min-width: 200px;">
        <!-- 최고음 녹음 완료 메시지가 여기에 표시됩니다 -->
    </div>
</div>



<!-- 메시지 컨테이너2: 녹음 진행 중 메시지 -->
<div id="statusMessage" style="font-family: 'Arial', sans-serif; font-size: 18px; color: #FF5722; text-align: center; margin-top: 10px; height: 40px;"></div>

<!-- 분석 시작 버튼 (최저음, 최고음 녹음 후에만 활성화) -->
<div style="display: flex; justify-content: center; text-align: center; margin-top: 20px; display: none;" id="analyzeButtonContainer">
    <button id="analyzeButton" style="padding: 15px 30px; background-color: #FF5722; color: white; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;">
        분석 시작
    </button>
</div>

<!-- 분석 결과 표시 영역 -->
<div id="songList" style="margin-top: 30px; margin-bottom: 50px; font-family: 'Arial', sans-serif; font-size: 18px; text-align: center;"></div>

<script>
    let lowRecorded = false;
    let highRecorded = false;

    // 최저음 녹음 버튼 클릭
    document.getElementById('startLowRecording').addEventListener('click', async function() {
        // 버튼 비활성화
        document.getElementById('startLowRecording').disabled = true;
        document.getElementById('startHighRecording').disabled = true;

        // 최저음 녹음 진행 메시지 출력 (메시지 컨테이너2 사용)
        document.getElementById('statusMessage').innerHTML = "최저음을 불러주세요: 장덕철-그날처럼 한 소절 (참 많은 시간이 흘러가고 넌 어떻게 사는지 참 궁금해)";
        await new Promise(resolve => setTimeout(resolve, 1000));  // 약간의 대기 시간 후에 녹음 시작
        document.getElementById('statusMessage').innerHTML += "<br>녹음 중입니다...";

        // 서버로 최저음 녹음 요청 보내기
        const responseLow = await fetch('/process_record', {
            method: 'POST',
            body: JSON.stringify({ pitch: 'low' }),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const resultLow = await responseLow.json();
        // 녹음 완료 상태 표시
        document.getElementById('lowMessageContainer').textContent = resultLow.message;
        lowRecorded = true;

        // 최고음 녹음 버튼 활성화
        document.getElementById('startHighRecording').disabled = false;

        // 분석 버튼 활성화 확인
        checkAnalyzeButton();
    });

    // 최고음 녹음 버튼 클릭
    document.getElementById('startHighRecording').addEventListener('click', async function() {
        // 버튼 비활성화
        document.getElementById('startLowRecording').disabled = true;
        document.getElementById('startHighRecording').disabled = true;

        // 최고음 녹음 진행 메시지 출력 (메시지 컨테이너2 사용)
        document.getElementById('statusMessage').innerHTML = "최고음을 불러주세요: 아이유-너랑나 한 소절 (너랑 나랑은 조금 남았지 몇날 몇실진 모르겠지만)";
        await new Promise(resolve => setTimeout(resolve, 1000));  // 약간의 대기 시간 후에 녹음 시작
        document.getElementById('statusMessage').innerHTML += "<br>녹음 중입니다...";

        // 서버로 최고음 녹음 요청 보내기
        const responseHigh = await fetch('/process_record', {
            method: 'POST',
            body: JSON.stringify({ pitch: 'high' }),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const resultHigh = await responseHigh.json();
        // 녹음 완료 상태 표시
        document.getElementById('highMessageContainer').textContent = resultHigh.message;
        highRecorded = true;

        // 분석 버튼 활성화 확인
        checkAnalyzeButton();
        document.getElementById('statusMessage').textContent = "녹음이 완료되었습니다. 결과를 확인해보세요!";
    });

    // 분석 버튼 활성화 확인 함수
    function checkAnalyzeButton() {
        if (lowRecorded && highRecorded) {
            document.getElementById('analyzeButtonContainer').style.display = 'block';
        }
    }

    // 분석 시작 버튼 클릭
    document.getElementById('analyzeButton').addEventListener('click', async function() {
        // 분석 시작 메시지 출력
        document.getElementById('songList').textContent = "분석 중입니다...";

        // 서버로 분석 요청 보내기
        const responseAnalysis = await fetch('/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const resultAnalysis = await responseAnalysis.json();

        // 분석 완료 후 추천 곡 리스트 표시
        document.getElementById('songList').innerHTML = "<h3>추천 곡 리스트:</h3><ul>";
        resultAnalysis.songs.forEach(song => {
            const listItem = document.createElement('li');
            listItem.textContent = `${song.singer} - ${song.title} (유사도: ${song.similarity.toFixed(6)})`;
            document.getElementById('songList').appendChild(listItem);
        });
        document.getElementById('songList').innerHTML += "</ul>";
    });
</script>
{% endblock %}
